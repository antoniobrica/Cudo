name: $(Date:yyyyMMdd).$(Rev:r).$(Build.BuildId)

trigger:
  branches:
    include:
      - dev
  paths:
    include:
      - package/*
      - apps/ms-account/*
      - apps/ms-document/*
      - apps/ms-project/*
      - apps/ms-task/*
      - apps/mf-account-app/*
      - apps/mf-container-app/*
      - apps/mf-task-app/*
      - apps/mf-document-app/*
      - apps/mf-project-app/*
      - deploy/docker-compose-ory/*
      - libs/*
jobs:
- job: cudogetchp
  pool: cudo-selfhosted-agent
  steps: 
    - checkout: self
      clean: false
      lfs: false
    - powershell: |
            $url="$(System.CollectionUri)/$(System.TeamProject)/_apis/git/repositories/$(Build.Repository.ID)/commits/$(Build.SourceVersion)/changes?api-version=5.1"
            $result = Invoke-RestMethod -Uri $url -Headers @{Authorization = "Bearer $(System.AccessToken)"} -Method GET
                       
            $changesFolder = $result.changes | Where-Object{$_.item.gitObjectType -match "tree"} | Select-Object -Property {$_.item.path}
            ######################################################common####################################################################            
            foreach($path in $changesFolder){
              if($path -match '/package')
             echo "##vso[task.setvariable variable=packages;isOutput=true]$True"
            break
            }
            }
            foreach($path in $changesFolder){
              if($path -match '/deploy/docker-compose-ory'){
             echo "##vso[task.setvariable variable=orydev;isOutput=true]$True"
            break
            }
            }
            ######################################################Frontend####################################################################            
            foreach($path in $changesFolder){
              if($path -match '/mf-account-app'){
             echo "##vso[task.setvariable variable=mfaccountapp;isOutput=true]$True"
            break
            }
            }
            foreach($path in $changesFolder){
              if($path -match '/mf-container-app'){
             echo "##vso[task.setvariable variable=mfcontainerapp;isOutput=true]$True"
            break
            }
            }
            foreach($path in $changesFolder){
              if($path -match '/mf-task-app'){
             echo "##vso[task.setvariable variable=mftaskapp;isOutput=true]$True"
            break
            }
            }
            foreach($path in $changesFolder){
              if($path -match '/mf-document-app'){
             echo "##vso[task.setvariable variable=mfdocumentapp;isOutput=true]$True"
            break
            }
            }
            foreach($path in $changesFolder){
              if($path -match '/mf-project-app'){
             echo "##vso[task.setvariable variable=mfprojectapp;isOutput=true]$True"
            break
            }
            }
            ######################################################Backend####################################################################            
            foreach($path in $changesFolder){
              if($path -match '/apps/ms-account'){
             echo "##vso[task.setvariable variable=msaccount;isOutput=true]$True"
            break
            }
            }
            foreach($path in $changesFolder){
              if($path -match '/apps/ms-document'){
             echo "##vso[task.setvariable variable=msdocument;isOutput=true]$True"
            break
            }
            }
            foreach($path in $changesFolder){
              if($path -match '/apps/ms-project'){
             echo "##vso[task.setvariable variable=msproject;isOutput=true]$True"
            break
            }
            }
            foreach($path in $changesFolder){
              if($path -match '/apps/ms-task'){
             echo "##vso[task.setvariable variable=mstask;isOutput=true]$True"
            break
            }
            }
      name: cudovars
      ##################################################Common#####################################################################################
- job: packages
  pool: cudo-selfhosted-agent
  dependsOn: cudogetchp
  condition: eq(dependencies.cudogetchp.outputs['cudovars.package'],  'true')
  steps:
          - checkout: self
            clean: false
            lfs: false
          - bash : |
                  rm -f package-lock.json
                  rm -f package.json
                  cp package/package.json .
                  npm install
- job: orydev
  pool: cudo-selfhosted-agent
  dependsOn: cudogetchp
  condition: eq(dependencies.cudogetchp.outputs['cudovars.orydev'], 'true')
  steps:
          - checkout: self
            clean: false
            lfs: false
          - bash : |
          - task: Docker@2
            displayName: Build and push an image to container registry
            inputs:
              command: buildAndPush
              repository: ory-dev
              dockerfile: deploy/docker-compose-ory/Dockerfile
              containerRegistry: dev-docker-registry
              tags: latest
      ###################################################Frontend###############################################################################
- job: mfaccountapp
  pool: cudo-selfhosted-agent
  dependsOn: cudogetchp
  condition: eq(dependencies.cudogetchp.outputs['cudovars.mfaccountapp'], 'true')
  steps:
          - checkout: self
            clean: false
            lfs: false
          - bash : |
                  npm run nx run-many -- --target=build --projects='mf-account-app' --with-deps --generatePackageJson=true
                  cp devops/docker/mf-dockerfile dist/apps/mf-account-app/Dockerfile
                  cp devops/docker/nginx.conf dist/apps/mf-account-app/
          - task: Docker@2
            displayName: Build and push an image to container registry
            inputs:
              command: buildAndPush
              repository: mf-account-app-dev
              dockerfile: dist/apps/mf-account-app/Dockerfile
              containerRegistry: dev-docker-registry
              tags: latest
- job: mfcontainerapp
  pool: cudo-selfhosted-agent
  dependsOn: cudogetchp
  condition: eq(dependencies.cudogetchp.outputs['cudovars.mfcontainerapp'], 'true')
  steps:
          - checkout: self
            clean: false
            lfs: false
          - bash : |
                  npm run nx run-many -- --target=build --projects='mf-container-app' --with-deps --generatePackageJson=true
                  cp devops/docker/mf-contain-dockerfile dist/apps/mf-container-app/Dockerfile
                  cp devops/docker/mf-contain-nginx.conf dist/apps/mf-container-app/
          - task: Docker@2
            displayName: Build and push an image to container registry
            inputs:
              command: buildAndPush
              repository: mf-container-app-dev
              dockerfile: dist/apps/mf-container-app/Dockerfile
              containerRegistry: dev-docker-registry
              tags: latest
- job: mftaskapp
  pool: cudo-selfhosted-agent
  dependsOn: cudogetchp
  condition: eq(dependencies.cudogetchp.outputs['cudovars.mftaskapp'], 'true')
  steps:
          - checkout: self
            clean: false
            lfs: false
          - bash : |
                  npm run nx run-many -- --target=build --projects='mf-task-app' --with-deps --generatePackageJson=true
                  cp devops/docker/mf-dockerfile dist/apps/mf-task-app/Dockerfile
                  cp devops/docker/nginx.conf dist/apps/mf-task-app/
          - task: Docker@2
            displayName: Build and push an image to container registry
            inputs:
              command: buildAndPush
              repository: mf-task-app-dev
              dockerfile: dist/apps/mf-task-app/Dockerfile
              containerRegistry: dev-docker-registry
              tags: latest
- job: mfdocumentapp
  pool: cudo-selfhosted-agent
  dependsOn: cudogetchp
  condition: eq(dependencies.cudogetchp.outputs['cudovars.mfdocumentapp'], 'true')
  steps:
          - checkout: self
            clean: false
            lfs: false
          - bash : |
                  npm run nx run-many -- --target=build --projects='mf-document-app' --with-deps --generatePackageJson=true
                  cp devops/docker/mf-dockerfile dist/apps/mf-document-app/Dockerfile
                  cp devops/docker/nginx.conf dist/apps/mf-document-app/
          - task: Docker@2
            displayName: Build and push an image to container registry
            inputs:
              command: buildAndPush
              repository: mf-document-app-dev
              dockerfile: dist/apps/mf-document-app/Dockerfile
              containerRegistry: dev-docker-registry
              tags: latest
- job: mfprojectapp
  pool: cudo-selfhosted-agent
  dependsOn: cudogetchp
  condition: eq(dependencies.cudogetchp.outputs['cudovars.mfprojectapp'], 'true')
  steps:
          - checkout: self
            clean: false
            lfs: false
          - bash : |
                  npm run nx run-many -- --target=build --projects='mf-project-app' --with-deps --generatePackageJson=true
                  cp devops/docker/mf-dockerfile dist/apps/mf-project-app/Dockerfile
                  cp devops/docker/nginx.conf dist/apps/mf-project-app/
          - task: Docker@2
            displayName: Build and push an image to container registry
            inputs:
              command: buildAndPush
              repository: mf-project-app-dev
              dockerfile: dist/apps/mf-project-app/Dockerfile
              containerRegistry: dev-docker-registry
              tags: latest
###################################################Backend####################################################################################
- job: msaccount
  pool: cudo-selfhosted-agent
  dependsOn: cudogetchp
  condition: eq(dependencies.cudogetchp.outputs['cudovars.msaccount'], 'true')
  steps:
          - checkout: self
            clean: false
            lfs: false
          - bash : |
                  npm run nx run-many -- --target=build --projects='ms-account' --with-deps --generatePackageJson=true
                  cp devops/docker/ms-dockerfile dist/apps/ms-account/Dockerfile
          - task: Docker@2
            displayName: Build and push an image to container registry
            inputs:
              command: buildAndPush
              repository: ms-account-dev
              dockerfile: dist/apps/ms-account/Dockerfile
              containerRegistry: dev-docker-registry
              tags: latest
  
- job: msdocument
  pool: cudo-selfhosted-agent
  dependsOn: cudogetchp
  condition: eq(dependencies.cudogetchp.outputs['cudovars.msdocument'], 'true')
  steps:
          - checkout: self
            clean: false
            lfs: false
          - bash : |
                  npm run nx run-many -- --target=build --projects='ms-document' --with-deps --generatePackageJson=true
                  cp devops/docker/ms-dockerfile dist/apps/ms-document/Dockerfile
          - task: Docker@2
            displayName: Build and push an image to container registry
            inputs:
              command: buildAndPush
              repository: ms-document-dev
              dockerfile: dist/apps/ms-document/Dockerfile
              containerRegistry: dev-docker-registry
              tags: latest
- job: msproject
  pool: cudo-selfhosted-agent
  dependsOn: cudogetchp
  condition: eq(dependencies.cudogetchp.outputs['cudovars.msproject'], 'true')
  steps:
          - checkout: self
            clean: false
            lfs: false
          - bash : |
                  npm run nx run-many -- --target=build --projects='ms-project' --with-deps --generatePackageJson=true
                  cp devops/docker/ms-dockerfile dist/apps/ms-project/Dockerfile
          - task: Docker@2
            displayName: Build and push an image to container registry
            inputs:
              command: buildAndPush
              repository: ms-project-dev
              dockerfile: dist/apps/ms-project/Dockerfile
              containerRegistry: dev-docker-registry
              tags: latest

- job: mstask
  pool: cudo-selfhosted-agent
  dependsOn: cudogetchp
  condition: eq(dependencies.cudogetchp.outputs['cudovars.mstask'], 'true')
  steps:
          - checkout: self
            clean: false
            lfs: false
          - bash : |
                  npm run nx run-many -- --target=build --projects='ms-task' --with-deps --generatePackageJson=true
                  cp devops/docker/ms-dockerfile dist/apps/ms-task/Dockerfile
          - task: Docker@2
            displayName: Build and push an image to container registry
            inputs:
              command: buildAndPush
              repository: ms-task-dev
              dockerfile: dist/apps/ms-task/Dockerfile
              containerRegistry: dev-docker-registry
              tags: latest
